worker_processes 4;

events { worker_connections 1024; }

http {
    upstream $prod {
        server myapp_nginx_1;
    }
    upstream $test {
        server myapptest_nginx_1;
    }
      # https://serverfault.com/questions/268633/controlling-nginx-proxy-target-using-a-cookie
    map $cookie_SLOT $app {
        default $prod;
        
        white $prod;
        black $test;
    }    
         
      server {
            listen 80;
            # See https://serverfault.com/questions/379675/nginx-reverse-proxy-url-rewrite
            location / {
                  proxy_pass         http://$app;
                  proxy_redirect     off;
                  proxy_set_header   Host $host;
                  proxy_set_header   X-Real-IP $remote_addr;
                  proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header   X-Forwarded-Host $server_name;
            }
      }
}